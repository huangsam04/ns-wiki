name: Auto Request AI Summary

on:
  push:
    branches:
      - main
      - master

jobs:
  request-ai-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed page names
        id: get_pages
        run: |
          echo "==== Detecting changed .md/.html files ===="
          page_names=""

          for file in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }}); do
            echo "Checking file: $file"
            if [[ "$file" == *.md || "$file" == *.html ]]; then
              echo "  -> Matched: $file"
              page_name="${file%.md}"
              page_name="${page_name%.html}"
              page_names="${page_names}\n${page_name}"
            fi
          done

          echo "==== Final Page Name List ===="
          echo -e "$page_names"

          echo "PAGE_NAMES<<EOF" >> $GITHUB_OUTPUT
          echo -e "$page_names" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: No valid changes
        if: steps.get_pages.outputs.PAGE_NAMES == ''
        run: echo "No .md or .html changes detected. Skip request."

      - name: Send request to AI Summary API
        env:
          AI_SUMMARY_ID: ${{ secrets.AI_SUMMARY_ID }}  # 引用 GitHub Secret
        if: steps.get_pages.outputs.PAGE_NAMES != ''
        run: |
          # 遍历所有变更的page_name
          while IFS= read -r page; do
            if [[ -z "$page" ]]; then continue; fi
            
            # URL编码page_name（避免特殊字符导致的问题）
            encoded_page=$(echo -n "$page" | jq -sRr @uri)
            request_url="https://nswiki.cn/${AI_SUMMARY_ID}/summary/${encoded_page}"
            echo -e "\n==== Requesting: $request_url ===="
            
            curl -s -v -w "\n==== Response Status Code: %{http_code} ====" \
              -o /tmp/response.txt \
              "$request_url" \
              -H "Content-Type: application/json" \
              --max-time 10
            
            # 输出完整的响应内容
            echo -e "\n==== Full Response Content ===="
            cat /tmp/response.txt
            echo -e "\n==== Request for '$page' completed ===="
            
            # 清理临时文件
            rm -f /tmp/response.txt
          done <<< "$(echo -e '${{ steps.get_pages.outputs.PAGE_NAMES }}')"
