name: Trigger AI Summaries

on:
  push:
    branches:
      - main
      - master

jobs:
  ai_summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Skip CI if commit contains [skip ci]
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MESSAGE"
          if [[ "$COMMIT_MESSAGE" == *"[skip ci]"* ]]; then
            echo "Skipping workflow because [skip ci] found in commit message."
            exit 0
          fi

      - name: Show changed files
        run: |
          echo "==== Changed files ===="
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true

      - name: Build page list
        id: build
        run: |
          echo "==== Processing files for AI Summary ===="
          pages=""

          for file in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }}); do
            echo "Checking file: $file"

            # only md or html
            if [[ "$file" == *.md || "$file" == *.html ]]; then
              echo "  -> Matched: $file"

              base="${file%.md}"
              base="${file%.html}"

              # page_name 对应 URL 路径
              pages="${pages}\n${base}"
            fi
          done

          echo "==== Final Page List ===="
          echo -e "$pages"

          echo "CHANGED_PAGES<<EOF" >> $GITHUB_OUTPUT
          echo -e "$pages" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: No changes detected
        if: steps.build.outputs.CHANGED_PAGES == ''
        run: echo "No .md or .html changes found. Nothing to process."

      - name: Trigger AI Summary
        if: steps.build.outputs.CHANGED_PAGES != ''
        run: |
          echo "==== Triggering AI Summary ===="
          for page in $(echo -e "${{ steps.build.outputs.CHANGED_PAGES }}"); do
            if [[ -z "$page" ]]; then
              continue
            fi

            summary_url="https://nswiki.cn/secret.ai_summary/summary/${page}"
            echo "Triggering: $summary_url"

            # 使用 curl GET 触发接口
            curl -v -i "$summary_url"

            echo "Triggered: $page"

      - name: Commit summary updates with [skip ci]
        run: |
          # 如果 workflow 自动生成了文件（可选），提交时加 [skip ci]
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Auto-update summaries [skip ci]" || echo "No changes to commit."
          git push origin HEAD:${{ github.ref }} || echo "Push failed or nothing to push."
