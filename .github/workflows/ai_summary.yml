name: AI Summaries

on:
  push:
    branches:
      - main
      - master

jobs:
  ai_summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Skip CI if commit contains [skip ci]
        run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MESSAGE"
          if [[ "$COMMIT_MESSAGE" == *"[skip ci]"* ]]; then
            echo "Skipping workflow because [skip ci] found in commit message."
            exit 0
          fi

      - name: Show changed files
        run: |
          echo "==== Changed files ===="
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true

      - name: Build page list
        id: build
        run: |
          echo "==== Processing files for AI Summary ===="
          pages=()

          while IFS= read -r file; do
            echo "Checking file: $file"
            if [[ "$file" == *.md || "$file" == *.html ]]; then
              echo "  -> Matched: $file"
              base="${file%.md}"
              base="${file%.html}"
              pages+=("$base")
            fi
          done < <(git diff --name-only ${{ github.event.before }} ${{ github.sha }})

          if [ ${#pages[@]} -eq 0 ]; then
            echo "No .md or .html changes found. Nothing to process."
            echo "CHANGED_PAGES=" >> $GITHUB_OUTPUT
          else
            echo "==== Final Page List ===="
            printf '%s\n' "${pages[@]}"
            echo "CHANGED_PAGES<<EOF" >> $GITHUB_OUTPUT
            printf '%s\n' "${pages[@]}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger AI Summary
        if: steps.build.outputs.CHANGED_PAGES != ''
        run: |
          echo "==== Triggering AI Summary ===="
          mapfile -t pages < <(echo "${{ steps.build.outputs.CHANGED_PAGES }}" | grep -v '^$')
          for page in "${pages[@]}"; do
            summary_url="https://nswiki.cn/secret.ai_summary/summary/${page}"
            echo "Triggering: $summary_url"

            # 使用 curl 获取接口，并显示详细 HTTP 信息
            curl -v -i "$summary_url"

            echo "Triggered: $page"

      - name: Finished
        run: echo "==== AI Summary trigger completed ===="
