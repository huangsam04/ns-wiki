name: Submit URLs to IndexNow

on:
  push:
    branches:
      - main
      - master

jobs:
  indexnow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show changed files
        run: |
          echo "==== Changed files ===="
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true

      - name: Build URL list
        id: build
        run: |
          echo "==== Processing files for IndexNow ===="
          urls=""

          for file in $(git diff --name-only ${{ github.event.before }} ${{ github.sha }}); do
            echo "Checking file: $file"

            # only md or html
            if [[ "$file" == *.md || "$file" == *.html ]]; then
              echo "  -> Matched: $file"

              base="${file%.md}"
              base="${base%.html}"

              url="${{ secrets.SITE_URL }}/zh/${base}"

              echo "  -> Final URL = $url"

              urls="${urls}\n${url}"
            fi
          done

          echo "==== Final URL List ===="
          echo -e "$urls"

          echo "CHANGED_URLS<<EOF" >> $GITHUB_OUTPUT
          echo -e "$urls" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: No changes detected
        if: steps.build.outputs.CHANGED_URLS == ''
        run: echo "No .md or .html changes found. Nothing to submit."

      - name: Submit to IndexNow
        if: steps.build.outputs.CHANGED_URLS != ''
        run: |
          JSON_PAYLOAD=$(jq -n \
            --arg host "$(echo ${{ secrets.SITE_URL }} | sed 's|https\?://||; s|/||')" \
            --arg key "${{ secrets.INDEXNOW_KEY }}" \
            --arg urls "${{ steps.build.outputs.CHANGED_URLS }}" \
            '{
              host: $host,
              key: $key,
              keyLocation: ("https://" + $host + "/" + $key + ".txt"),
              urlList: ($urls | split("\n") | map(select(length > 0)))
            }')

          echo "$JSON_PAYLOAD" > indexnow.json

          echo "Submitting to IndexNow..."
          curl -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            --data @indexnow.json
